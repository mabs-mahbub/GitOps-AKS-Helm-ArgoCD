# Docker
# Build and push an image to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

# Removed automatic trigger for manual execution
# The pipeline will now run only when manually triggered

trigger:
  - none

resources:
  - repo: self

variables:
  # Container registry service connection established during pipeline creation
  dockerRegistryServiceConnection: "e8bd4519-1a2d-48c7-b6fd-ff84507e9225"
  imageRepository: "bphattersportal"
  containerRegistry: "bpportalacr.azurecr.io"
  dockerfilePath: "$(Build.SourcesDirectory)/Dockerfile"
  tag: "$(Build.BuildId)"

  # Agent VM image name
  vmImageName: "ubuntu-latest"

stages:
  - stage: Build
    displayName: Build and Push Stage
    jobs:
      - job: Build
        displayName: Build and Push Docker Image
        pool:
          vmImage: $(vmImageName)
        steps:
          # Step 1: Log in to the Azure Container Registry (ACR)
          - task: Docker@2
            displayName: "Login to ACR"
            inputs:
              command: login
              containerRegistry: $(dockerRegistryServiceConnection)

          # Step 2: Build and push the Docker image to ACR
          - task: Docker@2
            displayName: "Build and Push Image to ACR"
            inputs:
              command: buildAndPush
              repository: $(imageRepository)
              dockerfile: $(dockerfilePath)
              containerRegistry: $(dockerRegistryServiceConnection)
              tags: |
                $(tag)

        # # Step 3: Deploy the Docker image to Azure Web App
        # - task: AzureRmWebAppDeployment@4
        #   displayName: 'Deploy Image to Azure Web App'
        #   inputs:
        #     ConnectionType: 'AzureRM'
        #     azureSubscription: 'Mabs-Subscription-01(1)(c9908b4c-1256-47c0-84ae-aa11abc88ab1)'
        #     appType: 'webAppContainer'
        #     WebAppName: 'bp-hatters-portal'
        #     DockerNamespace: '$(containerRegistry)'
        #     DockerRepository: '$(imageRepository)'
        #     DockerImageTag: '$(tag)'
